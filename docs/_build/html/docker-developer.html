

<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Creating a Docker image &mdash; COMPAS v02.22.00 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/COMPAS.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="References" href="references.html" />
    <link rel="prev" title="Building COMPAS locally" href="COMPAS-local-build.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> COMPAS
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="getting-started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="user-guide.html">User guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="developer-guide.html">Developer guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="SSE.html">Single star evolution</a></li>
<li class="toctree-l2"><a class="reference internal" href="BSE.html">Binary star evolution</a></li>
<li class="toctree-l2"><a class="reference internal" href="object-ids.html">Object identifiers</a></li>
<li class="toctree-l2"><a class="reference internal" href="services.html">Services</a></li>
<li class="toctree-l2"><a class="reference internal" href="floating-point-comparisons.html">Floating-point comparisons</a></li>
<li class="toctree-l2"><a class="reference internal" href="constants-dot-h.html">Constants source file</a></li>
<li class="toctree-l2"><a class="reference internal" href="changelog.html">Change log</a></li>
<li class="toctree-l2"><a class="reference internal" href="programming-style.html">Programming style</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="developer-building-compas.html">COMPAS build methods</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="COMPAS-local-build.html">Building COMPAS locally</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Creating a Docker image</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#github-ci-cd">GitHub CI/CD</a></li>
<li class="toctree-l4"><a class="reference internal" href="#dockerfile">Dockerfile</a></li>
<li class="toctree-l4"><a class="reference internal" href="#makefile-docker">Makefile.docker</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="references.html">References</a></li>
<li class="toctree-l1"><a class="reference internal" href="contact-us.html">Contact us</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">COMPAS</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="developer-guide.html">Developer guide</a> &raquo;</li>
        
          <li><a href="developer-building-compas.html">COMPAS build methods</a> &raquo;</li>
        
      <li>Creating a Docker image</li>
    
    

  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="creating-a-docker-image">
<h1>Creating a Docker image<a class="headerlink" href="#creating-a-docker-image" title="Permalink to this headline">¶</a></h1>
<div class="section" id="github-ci-cd">
<h2>GitHub CI/CD<a class="headerlink" href="#github-ci-cd" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">Docker</span></code> images of all versions of COMPAS (<code class="docutils literal notranslate"><span class="pre">dev</span></code> branch) are available at the
<a class="reference external" href="https://hub.docker.com/u/teamcompas">TeamCOMPAS dockerHub page</a>. Building of these images is performed automatically by the
<code class="docutils literal notranslate"><span class="pre">GitHub</span></code> CI/CD process.</p>
<p>Whenever a push to <a class="reference external" href="https://github.com/TeamCOMPAS/COMPAS/tree/dev">TeamCOMPAS/dev</a> occurs, a continuous deployment process
automatically
builds<a class="footnote-reference" href="#f1" id="id1">[1]</a> a new image and deploys it to <code class="docutils literal notranslate"><span class="pre">dockerHub</span></code> with a <cite>tag</cite><a class="footnote-reference" href="#f2" id="id2">[2]</a> that corresponds to the value of <code class="docutils literal notranslate"><span class="pre">VERSION_STRING</span></code>
in <code class="docutils literal notranslate"><span class="pre">changelog.h</span></code> (see <a class="reference internal" href="changelog.html"><span class="doc">Change log</span></a> for detailed information regarding <code class="docutils literal notranslate"><span class="pre">changelog.h</span></code>).</p>
<p>At time of writing, <cite>GitHub Actions</cite><a class="footnote-reference" href="#f3" id="id3">[3]</a> facilitates the above process. While this is convenient (because it's free and well
supported) it is somewhat slow - the COMPAS <code class="docutils literal notranslate"><span class="pre">Docker</span></code> image is available 5 - 10 minutes after pushing/merging. A future improvement
may be to create a <cite>runner</cite><a class="footnote-reference" href="#f4" id="id4">[4]</a> locally with a high core count that can be used to compile COMPAS quickly.</p>
<p>The Github Actions configuration is in <code class="docutils literal notranslate"><span class="pre">/.github/workflows/dockerhub-ci.yml</span></code>.</p>
<p>See the <a class="reference external" href="https://www.atlassian.com/continuous-delivery/principles/continuous-integration-vs-delivery-vs-deployment">Atlassian CI/CD</a>
documentation for detailed information regarding the <code class="docutils literal notranslate"><span class="pre">GitHub</span></code> CI/CD process.</p>
</div>
<div class="section" id="dockerfile">
<h2>Dockerfile<a class="headerlink" href="#dockerfile" title="Permalink to this headline">¶</a></h2>
<p>The Dockerfile<a class="footnote-reference" href="#f5" id="id5">[5]</a> defines how the docker image is constructed.</p>
<p>Images are created as a combination of layers. During the build process, each layer is cached and only updated on subsequent builds
if that layer would change.</p>
<p>The Dockerfile for COMPAS is made up of 8 layers:</p>
<blockquote>
<div><p><strong>FROM ubuntu:18.04</strong><a class="footnote-reference" href="#f6" id="id6">[6]</a> <br />
Use <a class="reference external" href="https://hub.docker.com/_/ubuntu">Ubuntu 18.04</a> as a base (provided by Docker Hub)</p>
<p><strong>WORKDIR /app/COMPAS</strong><a class="footnote-reference" href="#f7" id="id7">[7]</a> <br />
Effectively <code class="docutils literal notranslate"><span class="pre">cd</span> <span class="pre">/app/COMPAS</span></code> within the container.</p>
<p><strong>RUN apt-get update &amp;&amp; apt-get install -y ...</strong><a class="footnote-reference" href="#f8" id="id8">[8]</a> <br />
Install the required dependencies.</p>
<blockquote>
<div><ul class="simple">
<li><cite>-y</cite> so there's no prompt to install any of the packages.</li>
<li><cite>update</cite> and <cite>install</cite> are in the same layer because now if there are any updates, it will force all of the dependencies
to be re-installed</li>
</ul>
</div></blockquote>
<p><strong>RUN pip3 install numpy</strong><a class="footnote-reference" href="#f8" id="id9">[8]</a> <br />
Install numpy.</p>
<p><strong>COPY src/ src</strong><a class="footnote-reference" href="#f9" id="id10">[9]</a> <br />
Copy <code class="docutils literal notranslate"><span class="pre">./src/</span></code> directory from the local machine to <code class="docutils literal notranslate"><span class="pre">./src</span></code> in the container (remembering that <cite>WORKDIR</cite> changes the cwd).</p>
<p><strong>RUN mkdir obj bin logs</strong><a class="footnote-reference" href="#f8" id="id11">[8]</a> <br />
Create the directories required by COMPAS.</p>
<p><strong>ENV COMPAS_ROOT_DIR /app/COMPAS</strong><a class="footnote-reference" href="#f10" id="id12">[10]</a> <br />
Set the required environment variable(s).</p>
<p><strong>RUN cd src &amp;&amp; make -f Makefile.docker -j $(nproc)</strong><a class="footnote-reference" href="#f8" id="id13">[8]</a> <br />
Change to the <code class="docutils literal notranslate"><span class="pre">src</span></code> directory; make COMPAS using a specific makefile (see below) and as many cores as possible.</p>
</div></blockquote>
<p>A Dockerfile usually ends with a <code class="docutils literal notranslate"><span class="pre">CMD</span></code> directive that specifies what command should run when the container is started<a class="footnote-reference" href="#f11" id="id14">[11]</a>.
The COMPAS Dockerfile doesn't have a <code class="docutils literal notranslate"><span class="pre">CMD</span></code> directive because some users will want to run the executable directly and some will
want to use <code class="docutils literal notranslate"><span class="pre">pythonSubmit.py</span></code>.</p>
</div>
<div class="section" id="makefile-docker">
<h2>Makefile.docker<a class="headerlink" href="#makefile-docker" title="Permalink to this headline">¶</a></h2>
<p>A separate makefile is required for <code class="docutils literal notranslate"><span class="pre">Docker</span></code> in this scenario for two reasons:</p>
<blockquote>
<div><ol class="arabic simple">
<li>To separate compiled files from source files</li>
<li>To prevent the usage of the <code class="docutils literal notranslate"><span class="pre">gcc</span></code> <code class="docutils literal notranslate"><span class="pre">-march=native</span></code> compiler option</li>
</ol>
</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">-march=native</span></code> is a very useful optimisation for users who compile and run COMPAS on the same machine, however it causes fatal
errors when running COMPAS on a machine for which it was not compiled. The <code class="docutils literal notranslate"><span class="pre">-march=native</span></code> compiler option selects the CPU for
which code should be generated by determining the processor type of the <cite>compiling machine</cite>. Using <code class="docutils literal notranslate"><span class="pre">-march=native</span></code> enables all
instruction subsets supported by the compiling machine, thus producing an executable file that will perform better than it would
if the full native instruction set was not available, but some of those instructions may not be available for use on machines of
different architectures - hence the possible fatal run-time errors if the code is run on machines with different architectures).
See <a class="reference external" href="https://gcc.gnu.org/onlinedocs/gcc/x86-Options.html">gcc x86-Options</a> for detailed information regarding <code class="docutils literal notranslate"><span class="pre">-march</span></code>.</p>
<p>The Docker makefile provided (<code class="docutils literal notranslate"><span class="pre">Makefile.docker</span></code>) functions exactly like the local makefile provided (<code class="docutils literal notranslate"><span class="pre">Makefile</span></code>) in all other
respects.  See <a class="reference internal" href="COMPAS-local-build.html"><span class="doc">Building COMPAS locally</span></a> for a detailed description of the local makefile functionality.</p>
<p class="rubric">Footnotes</p>
<table class="docutils footnote" frame="void" id="f1" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td><a class="reference external" href="https://docs.docker.com/engine/reference/commandline/build/">https://docs.docker.com/engine/reference/commandline/build/</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="f2" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td><a class="reference external" href="https://docs.docker.com/engine/reference/commandline/tag/">https://docs.docker.com/engine/reference/commandline/tag/</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="f3" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[3]</a></td><td><a class="reference external" href="https://github.com/features/actions">https://github.com/features/actions</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="f4" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[4]</a></td><td><a class="reference external" href="https://help.github.com/en/actions/getting-started-with-github-actions/core-concepts-for-github-actions#runner">https://help.github.com/en/actions/getting-started-with-github-actions/core-concepts-for-github-actions#runner</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="f5" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id5">[5]</a></td><td><a class="reference external" href="https://docs.docker.com/engine/reference/builder/">https://docs.docker.com/engine/reference/builder/</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="f6" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id6">[6]</a></td><td><a class="reference external" href="https://docs.docker.com/engine/reference/builder/#from">https://docs.docker.com/engine/reference/builder/#from</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="f7" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id7">[7]</a></td><td><a class="reference external" href="https://docs.docker.com/engine/reference/builder/#workdir">https://docs.docker.com/engine/reference/builder/#workdir</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="f8" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[8]</td><td><em>(<a class="fn-backref" href="#id8">1</a>, <a class="fn-backref" href="#id9">2</a>, <a class="fn-backref" href="#id11">3</a>, <a class="fn-backref" href="#id13">4</a>)</em> <a class="reference external" href="https://docs.docker.com/engine/reference/builder/#run">https://docs.docker.com/engine/reference/builder/#run</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="f9" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id10">[9]</a></td><td><a class="reference external" href="https://docs.docker.com/engine/reference/builder/#copy">https://docs.docker.com/engine/reference/builder/#copy</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="f10" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id12">[10]</a></td><td><a class="reference external" href="https://docs.docker.com/engine/reference/builder/#env">https://docs.docker.com/engine/reference/builder/#env</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="f11" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id14">[11]</a></td><td><a class="reference external" href="https://docs.docker.com/engine/reference/builder/#cmd">https://docs.docker.com/engine/reference/builder/#cmd</a></td></tr>
</tbody>
</table>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="references.html" class="btn btn-neutral float-right" title="References" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="COMPAS-local-build.html" class="btn btn-neutral float-left" title="Building COMPAS locally" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, The Authors.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>